name: Deploy Surveyon via FTP

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-surveyon
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Call DB reset API if sql/mysql/init.sql changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WEB_RESET_URL: ${{ secrets.WEB_RESET_URL }}
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          REPO: ${{ github.repository }}
          BEFORE: ${{ github.event.before }}
          SHA: ${{ github.sha }}
        run: |
          set -e
          echo "Checking for changes in sql/mysql/init.sql..."
          git fetch --no-tags --prune --depth=2 --quiet

          changed=false

          # 1) Push diff (fast)
          if git diff --name-only "$BEFORE" "$SHA" | grep -q '^sql/mysql/init.sql$'; then
            echo "Detected via git diff"
            changed=true
          else
            echo "Not found in git diff, trying PR-based detection..."
            # 2) PR-based: find PRs associated with the commit, then check PR files
            prs=$(curl -s -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.groot-preview+json" \
              "https://api.github.com/repos/$REPO/commits/$SHA/pulls" | jq -r '.[].number' || true)
            for pr in $prs; do
              echo "Checking PR #$pr files..."
              files_json=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                "https://api.github.com/repos/$REPO/pulls/$pr/files?per_page=100")
              if echo "$files_json" | jq -r '.[].filename' | grep -xq 'sql/mysql/init.sql'; then
                echo "Detected in PR #$pr"
                changed=true
                break
              fi
            done
          fi

          if [ "$changed" = "true" ]; then
            echo "Calling reset API"
            status=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
              -H "X-Database-Name: $FTP_SERVER" \
              -H "Content-Type: application/json" \
              "$WEB_RESET_URL")
            echo "Reset API HTTP status: $status"
            if [ "$status" -ge 400 ]; then
              echo "Warning: reset API returned error status $status"
            fi
          else
            echo "No changes to sql/mysql/init.sql"
          fi

      - name: FTP Deploy
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT }}
          protocol: ftp

          local-dir: ./
          server-dir: ${{ secrets.FTP_REMOTE_PATH }}/

          dangerous-clean-slate: false

          exclude: |
            **/.git*
            **/.github/**
            **/node_modules/**
            **/vendor/**
            **/tests/**
            **/README.md
            **/.env

            # GIỮ NGUYÊN config TRÊN SERVER
            config/**
            **/config/**
